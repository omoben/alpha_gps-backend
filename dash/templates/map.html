<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map Interface</title>
    <!-- Leaflet and Plugins CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-search/dist/leaflet-search.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css" />
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <!-- Custom Features Tab -->
    <div id="custom-features-tab">
        <button onclick="showGeofences()" title="Geofences">ğŸ“ Geofences</button>
        <button onclick="showHeatmap()" title="Heatmap">ğŸ”¥ Heatmap</button>
        <button onclick="manageDevices()" title="Devices">ğŸ“± Devices</button>
        <button onclick="navigateHelp()" title="Help">â“ Help</button>
    </div>

    <!-- Navigation Tab -->
    <div id="nav-tab">
        <button onclick="navigateHome()" title="Home">ğŸ </button>
        <button onclick="navigateAccount()" title="Account">ğŸ‘¤</button>
        <button onclick="navigateLogout()" title="Logout">ğŸšª</button>
    </div>

    <!-- Filter Controls -->
    <div id="filter-controls">
        <label for="device-id">Device ID:</label>
        <input type="text" id="device-id" placeholder="Enter device ID" oninput="filterMarkers()" />
        <br>
        <label><input type="checkbox" id="geofences-toggle"> Geofences</label><br>
        <label><input type="checkbox" id="heatmap-toggle"> Heatmap</label>
    </div>

    <!-- Map Container -->
    <div id="map"></div>

    <!-- Leaflet and Plugins JS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/leaflet-search/dist/leaflet-search.min.js"></script>
    <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>

    <!-- Map Script -->
    <script>
        // Initialize Map
        const map = L.map('map').setView([6.3329, 5.6037], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        const markers = L.markerClusterGroup();
        const allMarkers = [];
        const geofencesLayer = L.layerGroup().addTo(map);
        const heatmapLayer = L.layerGroup().addTo(map);

        // Add Marker Function
        function addMarker(data) {
            if (data.latitude && data.longitude) {
                const marker = L.marker([data.latitude, data.longitude])
                    .bindPopup(`<b>${data.device_id}</b><br>${data.equipment}<br>${data.state}<br>${data.timestamp}`);
                markers.addLayer(marker);
                allMarkers.push({ marker: marker, data: data });
            }
        }

        // Filter Markers Based on Device ID
        function filterMarkers() {
            const filterValue = document.getElementById('device-id').value.toLowerCase();
            markers.clearLayers(); // Clear current markers

            let foundDevice = false; // Flag for found device

            allMarkers.forEach(item => {
                if (item.data.device_id.toLowerCase().includes(filterValue)) {
                    markers.addLayer(item.marker); // Add filtered marker
                    if (!foundDevice) {
                        map.setView(item.marker.getLatLng(), 15); // Focus on the first match
                        foundDevice = true;
                    }
                }
            });

            // Reset the view if no matches
            if (!foundDevice && filterValue === '') {
                map.setView([6.3329, 5.6037], 13);
            }
        }

        // Fetch GPS Data on Load
        fetch('/api/gps')
            .then(response => response.json())
            .then(gpsData => {
                gpsData.forEach(addMarker);
                map.addLayer(markers);
            });

        // Custom Features Button Actions
        function showGeofences() { alert("Geofences feature clicked!"); }
        function showHeatmap() { alert("Heatmap feature clicked!"); }
        function manageDevices() { alert("Devices feature clicked!"); }
        function navigateHelp() { alert("Help feature clicked!"); }

        // Navigation Button Actions
        function navigateHome() { window.location.href = '/'; }
        function navigateAccount() { window.location.href = '/account'; }
        function navigateLogout() { window.location.href = '/logout'; }
    </script>
</body>
</html>
